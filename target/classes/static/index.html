<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Java Chat Room</title>
    <style>
        /* 基础重置 */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(135deg, #ff6ec4, #7873f5, #6a11cb);
            background-size: 600% 600%;
            animation: gradientBG 15s ease infinite;
            color: #fff;
        }

        @keyframes gradientBG {
            0%{background-position:0% 50%}
            50%{background-position:100% 50%}
            100%{background-position:0% 50%}
        }

        h1 {
            margin: 50px 0 30px;
            font-size: 3rem;
            font-weight: 700;
            text-shadow: 2px 2px 15px rgba(0,0,0,0.3);
            text-align: center;
        }

        #chatContainer {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(25px);
            border-radius: 25px;
            padding: 30px;
            width: 95%;
            max-width: 900px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }

        #userSelect {
            width: 100%;
            padding: 15px;
            border-radius: 25px;
            border: none;
            font-size: 1rem;
            outline: none;
            background: linear-gradient(135deg, #ff9a9e, #fad0c4);
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            -webkit-appearance: none;
            appearance: none;
            position: relative;
            margin-bottom: 12px;
        }

        #chatBox {
            width: 100%;
            height: 500px;
            border-radius: 20px;
            overflow-y: auto;
            padding: 20px;
            background: rgba(0,0,0,0.15);
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            backdrop-filter: blur(15px);
        }

        .message {
            padding: 12px 20px;
            border-radius: 30px;
            max-width: 70%;
            word-wrap: break-word;
            position: relative;
            font-size: 1rem;
            line-height: 1.4;
            animation: fadeIn 0.4s ease;
            color: #fff;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        @keyframes fadeIn {
            from {opacity:0; transform:translateY(8px);}
            to {opacity:1; transform:translateY(0);}
        }

        .message[data-user] {
            background: linear-gradient(135deg, #ff9a9e, #fad0c4);
        }
        .message[data-user="self"] {
            background: linear-gradient(135deg, #a18cd1, #fbc2eb);
            align-self: flex-end;
        }
        .message[data-user="system"] {
            background: linear-gradient(135deg, rgba(255, 242, 153,0.8), rgba(255, 200, 112,0.8));
            color: #333;
            align-self: center;
            border: 1px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(15px);
            font-weight: 600;
        }

        .message .time {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.7);
            position: absolute;
            bottom: -15px;
            right: 15px;
        }

        #inputContainer { display:flex; gap:15px; }

        #messageInput {
            flex:1;
            padding:15px 20px;
            border-radius:25px;
            border:none;
            font-size:1rem;
            outline:none;
            background: rgba(255,255,255,0.15);
            color:#fff;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        #messageInput:focus {
            box-shadow: 0 0 15px 3px rgba(255, 215, 0, 0.7), 0 0 30px 10px rgba(255, 223, 0, 0.5);
            animation: glowPulse 1.2s ease-in-out infinite alternate;
            border: 1px solid rgba(255, 215, 0, 0.8);
        }

        @keyframes glowPulse {
            0% { box-shadow: 0 0 10px 2px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 20px 5px rgba(255, 215, 0, 0.8); }
            100% { box-shadow: 0 0 15px 3px rgba(255, 215, 0, 0.7); }
        }

        #sendBtn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg, #ff416c, #ff4b2b);
            color: #fff;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        #chatBox::-webkit-scrollbar { width: 10px; }
        #chatBox::-webkit-scrollbar-thumb { background-color: rgba(255,255,255,0.3); border-radius: 5px; }

        /* profile modal small style */
        #profileModal { display:none; }
    </style>
</head>
<body>

<h1>Java Chat Room</h1>

<div id="chatContainer">
    <label for="userSelect">发送给:</label>
    <select id="userSelect">
        <option value="">所有人 (群聊)</option>
    </select>

    <div id="chatBox"></div>

    <div id="inputContainer">
        <input type="text" id="messageInput" placeholder="输入消息...">
        <button id="sendBtn">发送</button>
    </div>
</div>

<script>
    (function(){
        // 初始化变量为 null，不再从 localStorage 获取
        let username = null;
        let displayName = null;
        let avatarUrl = null;

        const chatBox = document.getElementById('chatBox');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const userSelect = document.getElementById('userSelect');

        let onlineUsers = new Set();
        let userColors = {};
        let ws = null;

        // 动态生成 ws 地址
        function wsUrlForUser(u) {
            const proto = (location.protocol === 'https:') ? 'wss:' : 'ws:';
            return `${proto}//${location.host}/chat?username=${encodeURIComponent(u)}`;
        }

        // 颜色挑选（保持一致）
        function getUserColor(user) {
            if (!user) return 'linear-gradient(135deg,#e0e0e0,#cfcfcf)';
            if (user === username) return 'linear-gradient(135deg,#a18cd1,#fbc2eb)';
            if (user === '系统') return 'linear-gradient(135deg, rgba(255, 242, 153,0.8), rgba(255, 200, 112,0.8))';
            if (!userColors[user]) {
                const colors = [
                    'linear-gradient(135deg,#ff9a9e,#fad0c4)',
                    'linear-gradient(135deg,#a1c4fd,#c2e9fb)',
                    'linear-gradient(135deg,#fbc2eb,#a6c1ee)',
                    'linear-gradient(135deg,#84fab0,#8fd3f4)',
                    'linear-gradient(135deg,#fccb90,#d57eeb)'
                ];
                userColors[user] = colors[Math.floor(Math.abs(hashString(user)) % colors.length)];
            }
            return userColors[user];
        }
        function hashString(s) {
            let h = 2166136261 >>> 0;
            for (let i = 0; i < s.length; i++) h = Math.imul(h ^ s.charCodeAt(i), 16777619);
            return h >>> 0;
        }

        // 打开或重建 WS
        function connectWs() {
            if (!username) return;
            if (ws) { try { ws.close(); } catch(e){} }
            ws = new WebSocket(wsUrlForUser(username));
            ws.onopen = () => appendSystem('WebSocket 已连接');
            ws.onmessage = evt => {
                try {
                    const msg = JSON.parse(evt.data);
                    // 简单展示逻辑
                    if (msg.type === 'group' || msg.toUser === username || msg.fromUser === username) {
                        displayMessage(msg);
                    }
                    if (msg.fromUser && msg.fromUser !== '系统') {
                        onlineUsers.add(msg.fromUser);
                        updateUserSelect();
                    }
                } catch (e) {
                    console.error('ws message parse', e);
                }
            };
            ws.onclose = () => appendSystem('WebSocket 已关闭');
            ws.onerror = () => appendSystem('WebSocket 错误');
            window.__chat_ws = ws;
        }

        // 生成默认头像 URL
        function generateAvatarUrl(name) {
            name = (name || '游客').trim() || '游客';
            return 'https://ui-avatars.com/api/?name=' + encodeURIComponent(name) + '&background=random&size=128';
        }

        // 发送消息
        function sendMessage(){
            const content = messageInput.value.trim();
            if (!content) return;
            const toUser = userSelect.value || null;
            const type = toUser ? 'private' : 'group';
            const payload = {
                fromUser: username,
                fromDisplayName: displayName,
                toUser,
                content,
                type,
                time: new Date().toISOString()
            };
            try {
                (ws || window.__chat_ws).send(JSON.stringify(payload));
            } catch (e) {
                appendSystem('发送失败：尚未连接');
                return;
            }
            messageInput.value = '';
        }

        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });

        // 显示消息（用户名可点击）
        function displayMessage(msg) {
            console.log('接收的 msg 对象：', msg);
            const div = document.createElement('div');
            div.className = 'message';
            const userKey = msg.fromUser === username ? 'self' : (msg.fromUser === '系统' ? 'system' : msg.fromUser);
            div.setAttribute('data-user', userKey);
            div.style.background = getUserColor(msg.fromUser);

            const nameSpan = document.createElement('span');
            nameSpan.style.fontWeight = '700';
            nameSpan.style.cursor = 'pointer';
            nameSpan.style.marginRight = '8px';
            nameSpan.title = '查看个人主页';

            const fromUser = msg.fromUser || '';
            // 如果没有显示名，使用用户名作为显示名部分（仍会呈现为 名称(用户名)）
            const fromDisplay = msg.fromDisplayName && msg.fromDisplayName.trim() ? msg.fromDisplayName.trim() : fromUser;

            let displayText;
            if (fromUser === '系统') {
                displayText = '系统';
                nameSpan.style.cursor = 'default';
            } else {
                displayText = `${fromDisplay} (${fromUser})`;
            }
            nameSpan.textContent = displayText;

            if (fromUser !== '系统') {
                nameSpan.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showProfileModal(msg.fromUser);
                });
            }

            const contentSpan = document.createElement('span');
            const toText = msg.type === 'private' ? ` (私聊→${msg.toUser})` : '';
            contentSpan.textContent = `${toText} ${msg.content}`;

            const timeSpan = document.createElement('div');
            timeSpan.className = 'time';
            try {
                timeSpan.textContent = new Date(msg.time || Date.now()).toLocaleTimeString();
            } catch (e) {
                timeSpan.textContent = '';
            }

            div.appendChild(nameSpan);
            div.appendChild(contentSpan);
            div.appendChild(timeSpan);

            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function appendSystem(text) {
            displayMessage({ fromUser: '系统', fromDisplayName: '系统', content: text, type: 'system', time: new Date().toISOString() });
        }

        // 更新在线用户下拉（保留当前选择）
        function updateUserSelect() {
            const prev = userSelect.value;
            userSelect.innerHTML = '<option value="">所有人（群聊）</option>';
            Array.from(onlineUsers).sort().forEach(user => {
                if (user === username) return;
                const opt = document.createElement('option');
                opt.value = user;
                opt.textContent = user;
                userSelect.appendChild(opt);
            });
            userSelect.value = prev;
        }

        // 打开 profile.html 新窗口
        function openProfileWindow(user) {
            if (!user) return;
            window.open(`/profile.html?username=${encodeURIComponent(user)}`, '_blank', 'noopener');
        }

        // 在当前页显示 Modal（从后端获取资料）
        function showProfileModal(user) {
            if (!user) return;
            fetch(`/api/profile/${encodeURIComponent(user)}`)
                .then(res => {
                    if (!res.ok) throw new Error('无法读取资料');
                    return res.json();
                })
                .then(p => {
                    let modal = document.getElementById('profileModal');
                    if (!modal) {
                        modal = document.createElement('div');
                        modal.id = 'profileModal';
                        Object.assign(modal.style, {
                            position: 'fixed', left: 0, top: 0, right: 0, bottom: 0,
                            display: 'flex', alignItems: 'center', justifyContent: 'center',
                            background: 'rgba(0,0,0,0.6)', zIndex: 9999
                        });
                        const card = document.createElement('div');
                        Object.assign(card.style, {
                            background: '#fff', color: '#000', padding: '20px', borderRadius: '12px', width: '360px',
                            boxShadow: '0 10px 30px rgba(0,0,0,0.5)', textAlign: 'left'
                        });
                        card.innerHTML = `
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                            <strong id="pmName"></strong>
                            <button id="pmClose" style="background:#eee;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;">关闭</button>
                        </div>
                        <div style="display:flex;gap:12px;align-items:center;margin-bottom:10px;">
                            <img id="pmAvatar" src="" alt="avatar" style="width:72px;height:72px;border-radius:8px;object-fit:cover;background:#f0f0f0"/>
                            <div>
                                <div id="pmDisplayName" style="font-weight:600"></div>
                                <div id="pmBio" style="font-size:0.9rem;color:#555"></div>
                            </div>
                        </div>
                        <div id="pmStatus" style="font-size:0.9rem;color:#333;margin-bottom:8px;"></div>
                        <div style="text-align:right"><button id="pmOpenFull" style="padding:8px 12px;border-radius:8px;background:#007bff;color:#fff;border:none;cursor:pointer;">打开完整页面</button></div>
                    `;
                        modal.appendChild(card);
                        document.body.appendChild(modal);

                        modal.querySelector('#pmClose').addEventListener('click', () => modal.remove());
                        modal.querySelector('#pmOpenFull').addEventListener('click', () => {
                            openProfileWindow(user);
                        });
                    }

                    modal.querySelector('#pmName').textContent = p.username || user;
                    modal.querySelector('#pmAvatar').src = (p.avatarUrl && p.avatarUrl.trim()) ? p.avatarUrl : generateAvatarUrl(p.displayName || p.username);
                    modal.querySelector('#pmDisplayName').textContent = p.displayName || p.username;
                    modal.querySelector('#pmBio').textContent = p.bio || '';
                    modal.querySelector('#pmStatus').textContent = p.online ? '在线' : (`最后在线: ${p.lastSeen ? new Date(p.lastSeen).toLocaleString() : '未知'}`);

                    modal.style.display = 'flex';
                })
                .catch(err => {
                    appendSystem('获取用户资料失败');
                    console.error(err);
                });
        }

        // 启动用户设置 modal（强制显示，每次都需要填写）
        function showUserModal() {
            const modal = document.createElement('div');
            Object.assign(modal.style, {
                position:'fixed', inset:0, display:'flex', alignItems:'center', justifyContent:'center',
                background:'rgba(0,0,0,0.6)', zIndex:9999
            });
            modal.innerHTML = `
            <div style="background:#fff;color:#000;padding:20px;border-radius:12px;width:360px;box-shadow:0 10px 30px rgba(0,0,0,0.4)">
                <h3 style="margin-bottom:8px">设置你的资料</h3>
                <label style="display:block;margin-bottom:8px"><div style="font-size:0.9rem;color:#444">用户名（必填，用于连接）</div><input id="u_input" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc" /></label>
                <label style="display:block;margin-bottom:8px"><div style="font-size:0.9rem;color:#444">显示名（必填，聊天室显示）</div><input id="d_input" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc" /></label>
                <label style="display:block;margin-bottom:12px"><div style="font-size:0.9rem;color:#444">头像 URL（可选）</div><input id="a_input" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc" /></label>
                <div style="text-align:right">
                    <button id="startBtn" style="padding:8px 12px;border-radius:8px;border:none;background:#007bff;color:#fff;cursor:pointer">开始聊天</button>
                </div>
            </div>
        `;
            document.body.appendChild(modal);

            modal.querySelector('#startBtn').addEventListener('click', async () => {
                const u = modal.querySelector('#u_input').value.trim();
                const d = modal.querySelector('#d_input').value.trim();
                if (!u) { alert('用户名为必填项'); return; }
                if (!d) { alert('显示名为必填项'); return; }

                username = u;
                displayName = d;
                const aVal = modal.querySelector('#a_input').value.trim();
                avatarUrl = aVal || null; // 如果输入为空，则为 null

                // --- 新增代码：开始聊天前，先将资料更新到后端 ---
                try {
                    const profileUpdate = {
                        displayName: displayName,
                        avatarUrl: avatarUrl
                        // bio 可以留空，让用户在 profile 页面编辑
                    };

                    const res = await fetch(`/api/profile/${encodeURIComponent(username)}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(profileUpdate)
                    });

                    if (!res.ok) {
                        throw new Error(`保存资料失败: ${res.status}`);
                    }

                    // 可选：从后端返回的确认信息中更新本地变量
                    const savedProfile = await res.json();
                    displayName = savedProfile.displayName;
                    avatarUrl = savedProfile.avatarUrl;

                } catch (e) {
                    console.error(e);
                    alert('无法连接到服务器以保存您的资料，请稍后重试。');
                    return; // 保存失败则不继续
                }
                // --- 新增代码结束 ---

                modal.remove();
                startApp();
            });

            // 阻止点击遮罩直接关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    alert('请填写用户名和显示名以继续');
                }
            });
        }

        // 启动应用：连接 WS，绑定事件等
        function startApp() {
            document.title = `${displayName} - Java Chat Room`;
            connectWs();
            // 把自己加入在线列表，后端最终以实际连入为准
            onlineUsers.add(username);
            updateUserSelect();
        }

        // 页面加载时直接显示用户设置 modal
        window.addEventListener('load', showUserModal);

        // 暴露给页面其余脚本（兼容）
        window.chatUser = {
            getUsername: () => username,
            getDisplayName: () => displayName,
            getAvatarUrl: () => avatarUrl
        };
        window.connectChatWs = connectWs;
        window.openProfileWindow = openProfileWindow;
        window.showProfileModal = showProfileModal;
    })();
</script>
</body>
</html>